---
name: Update Phoenix Template

# This workflow requires repository settings to allow GitHub Actions to create PRs:
# Settings > Actions > General > Workflow permissions:
# - Select "Read and write permissions"
# - Check "Allow GitHub Actions to create and approve pull requests"
#
# For auto-merge to work:
# Settings > General > Pull Requests:
# - Check "Allow auto-merge"

on:
  schedule:
    - cron: "0 0 * * 0" # Weekly on Sunday
  workflow_dispatch: # Allow manual triggering

permissions:
  contents: write
  pull-requests: write

jobs:
  update-phoenix:
    runs-on: ubuntu-latest
    defaults:
      run:
        shell: devenv shell bash -- -e {0}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install Nix
        uses: cachix/install-nix-action@v31
        with:
          nix_path: nixpkgs=channel:nixpkgs-unstable

      - uses: cachix/cachix-action@v16
        with:
          name: devenv

      - name: Install devenv
        shell: bash
        run: nix profile install nixpkgs#devenv


      - name: Check current Phoenix version
        id: current_version
        run: |
          CURRENT_VERSION=$(grep -o "version:.*\".*\"" mix.exs | cut -d'"' -f2 || echo "none")
          echo "Current Phoenix version: $CURRENT_VERSION"
          echo "current_version=$CURRENT_VERSION" >> $GITHUB_OUTPUT

      - name: Get latest Phoenix version
        id: latest_version
        run: |
          # Install Elixir/Phoenix dependencies
          mix local.hex --force
          mix archive.install hex phx_new --force
          LATEST_VERSION=$(mix hex.info phoenix | grep -o "Version:.*[0-9]\.[0-9]\.[0-9]" | cut -d':' -f2 | tr -d ' ')
          echo "Latest Phoenix version: $LATEST_VERSION"
          echo "latest_version=$LATEST_VERSION" >> $GITHUB_OUTPUT

      - name: Regenerate Phoenix application if newer version available
        if: steps.current_version.outputs.current_version != steps.latest_version.outputs.latest_version
        run: |
          # Backup config files that might be customized
          mkdir -p backup
          [ -f "config/dev.exs" ] && cp config/dev.exs backup/
          [ -f "config/test.exs" ] && cp config/test.exs backup/

          # Remove existing Phoenix files except for custom modifications
          find . -type f -not -path "./.git/*" -not -path "./devenv*" -not -path "./.github/*" -not -path "./backup/*" -not -name "README.md" -not -name "LICENSE" -not -name ".gitignore" -not -name ".envrc" -delete

          # Generate new Phoenix application
          echo Y | mix phx.new . --module PhoenixDevenv --app phoenix_devenv --no-install

          # Restore backed up config files
          [ -f "backup/dev.exs" ] && cp backup/dev.exs config/
          [ -f "backup/test.exs" ] && cp backup/test.exs config/

          # Clean up backup directory
          rm -rf backup

          # Update database configuration
          sed -i 's/username: "postgres",/username: "postgres",\n  password: "postgres",/' config/dev.exs
          sed -i 's/username: "postgres",/username: "postgres",\n  password: "postgres",/' config/test.exs

          # Install dependencies
          mix deps.get
          mix deps.compile

          echo "Phoenix template updated to version $(grep -o "version:.*\".*\"" mix.exs | cut -d'"' -f2)"

      - name: Create Pull Request
        id: cpr
        if: steps.current_version.outputs.current_version != steps.latest_version.outputs.latest_version
        uses: peter-evans/create-pull-request@v7
        with:
          commit-message: "Update Phoenix to version ${{ steps.latest_version.outputs.latest_version }}"
          title: "Update Phoenix to version ${{ steps.latest_version.outputs.latest_version }}"
          body: |
            This PR updates the Phoenix template to version ${{ steps.latest_version.outputs.latest_version }}.

            Changes:
            - Updated Phoenix dependencies
            - Regenerated Phoenix application structure
            - Preserved customized configuration
            
            This PR will be auto-merged if all CI checks pass.
          branch: update-phoenix-template
          delete-branch: true
      # - name: Enable auto-merge
      #   if: steps.cpr.outputs.pull-request-operation == 'created'
      #   uses: peter-evans/enable-pull-request-automerge@v3
      #   with:
      #     token: ${{ secrets.GITHUB_TOKEN }}
      #     pull-request-number: ${{ steps.cpr.outputs.pull-request-number }}
      #     merge-method: squash
